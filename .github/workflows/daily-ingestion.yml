name: Daily SEC Cybersecurity Data Ingestion

on:
  schedule:
    # Run daily at 6:00 AM ET (11:00 AM UTC)
    - cron: '0 11 * * *'
  workflow_dispatch:  # Allow manual triggers
    inputs:
      date_range_start:
        description: 'Start date (YYYY-MM-DD) - optional'
        required: false
        type: string
      date_range_end:
        description: 'End date (YYYY-MM-DD) - optional'
        required: false
        type: string
      filing_types:
        description: 'Filing types'
        required: false
        type: choice
        default: 'both'
        options:
          - '8-K'
          - '10-K'
          - 'both'

permissions:
  contents: write
  issues: write
  
env:
  DATAMULE_API_KEY: ${{ secrets.DATAMULE_API_KEY }}
  PYTHON_VERSION: '3.11'

jobs:
  ingest-8k-filings:
    name: Ingest 8-K Filings (Item 1.05)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.filing_types == '' || github.event.inputs.filing_types == '8-K' || github.event.inputs.filing_types == 'both' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/scripts/requirements.txt
      
      - name: Configure datamule
        run: |
          python .github/scripts/configure_datamule.py
      
      - name: Download and parse 8-K filings
        run: |
          if [ -n "${{ github.event.inputs.date_range_start }}" ] && [ -n "${{ github.event.inputs.date_range_end }}" ]; then
            python .github/scripts/ingest_filings.py \
              --filing-type 8-K \
              --start-date "${{ github.event.inputs.date_range_start }}" \
              --end-date "${{ github.event.inputs.date_range_end }}"
          else
            python .github/scripts/ingest_filings.py --filing-type 8-K --lookback-days 1
          fi
      
      - name: Parse 8-K cybersecurity disclosures
        run: |
          python .github/scripts/parse_8k_disclosures.py
      
      - name: Generate statistics
        run: |
          python .github/scripts/generate_statistics.py --filing-type 8K
      
      - name: Commit and push changes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/8K/ || true
          git add stats/ || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update 8-K cybersecurity disclosures [$(date +'%Y-%m-%d')]"
            git push
          fi

  ingest-10k-filings:
    name: Ingest 10-K Filings (Item 106 & 407j)
    runs-on: ubuntu-latest
    needs: ingest-8k-filings
    if: ${{ always() && (github.event.inputs.filing_types == '' || github.event.inputs.filing_types == '10-K' || github.event.inputs.filing_types == 'both') }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/scripts/requirements.txt
      
      - name: Configure datamule
        run: |
          python .github/scripts/configure_datamule.py
      
      - name: Download and parse 10-K filings
        run: |
          if [ -n "${{ github.event.inputs.date_range_start }}" ] && [ -n "${{ github.event.inputs.date_range_end }}" ]; then
            python .github/scripts/ingest_filings.py \
              --filing-type 10-K \
              --start-date "${{ github.event.inputs.date_range_start }}" \
              --end-date "${{ github.event.inputs.date_range_end }}"
          else
            # For 10-K, look back 7 days since they're less frequent
            python .github/scripts/ingest_filings.py --filing-type 10-K --lookback-days 7
          fi
      
      - name: Parse 10-K cybersecurity disclosures
        run: |
          python .github/scripts/parse_10k_disclosures.py
      
      - name: Generate statistics
        run: |
          python .github/scripts/generate_statistics.py --filing-type 10K
      
      - name: Commit and push changes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/10K/ || true
          git add stats/ || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update 10-K cybersecurity disclosures [$(date +'%Y-%m-%d')]"
            git push
          fi

  create-summary:
    name: Create Daily Summary
    runs-on: ubuntu-latest
    needs: [ingest-8k-filings, ingest-10k-filings]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Generate daily summary
        run: |
          python .github/scripts/generate_daily_summary.py
        continue-on-error: true
      
      - name: Create issue with summary
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            try {
              const summary = fs.readFileSync('.github/outputs/daily_summary.md', 'utf8');
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Daily Ingestion Summary - ${new Date().toISOString().split('T')[0]}`,
                body: summary,
                labels: ['automated', 'daily-summary']
              });
            } catch (error) {
              console.log('Could not create summary issue:', error.message);
            }