name: Daily SEC Cybersecurity Data Ingestion

on:
  schedule:
    # Run daily at 6:00 AM ET (11:00 AM UTC)
    - cron: '0 11 * * *'
  workflow_dispatch:  # Allow manual triggers
    inputs:
      date_range_start:
        description: 'Start date (YYYY-MM-DD) - optional'
        required: false
      date_range_end:
        description: 'End date (YYYY-MM-DD) - optional'
        required: false
      filing_types:
        description: 'Filing types (comma-separated: 8-K,10-K)'
        required: false
        default: '8-K,10-K'

env:
  DATAMULE_API_KEY: ${{ secrets.DATAMULE_API_KEY }}
  PYTHON_VERSION: '3.11'

jobs:
  ingest-8k-filings:
    name: Ingest 8-K Filings (Item 1.05)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/scripts/requirements.txt
      
      - name: Configure datamule
        run: |
          python .github/scripts/configure_datamule.py
      
      - name: Download 8-K filings
        run: |
          python .github/scripts/download_8k_filings.py \
            --start-date "${{ github.event.inputs.date_range_start }}" \
            --end-date "${{ github.event.inputs.date_range_end }}"
      
      - name: Parse 8-K cybersecurity disclosures
        run: |
          python .github/scripts/parse_8k_disclosures.py
      
      - name: Generate statistics
        id: stats
        run: |
          python .github/scripts/generate_statistics.py --filing-type 8K
      
      - name: Commit and push changes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/8K/
          git add stats/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update 8-K cybersecurity disclosures [$(date +'%Y-%m-%d')]"
            git push
          fi

  ingest-10k-filings:
    name: Ingest 10-K Filings (Item 106 & 407j)
    runs-on: ubuntu-latest
    needs: ingest-8k-filings  # Run sequentially to avoid conflicts
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install datamule pandas pyyaml lxml beautifulsoup4 requests
      
      - name: Configure datamule
        run: |
          python .github/scripts/configure_datamule.py
      
      - name: Download 10-K filings
        run: |
          python .github/scripts/download_10k_filings.py \
            --start-date "${{ github.event.inputs.date_range_start }}" \
            --end-date "${{ github.event.inputs.date_range_end }}"
      
      - name: Parse 10-K cybersecurity disclosures
        run: |
          python .github/scripts/parse_10k_disclosures.py
      
      - name: Generate statistics
        id: stats
        run: |
          python .github/scripts/generate_statistics.py --filing-type 10K
      
      - name: Commit and push changes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/10K/
          git add stats/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update 10-K cybersecurity disclosures [$(date +'%Y-%m-%d')]"
            git push
          fi

  create-summary:
    name: Create Daily Summary
    runs-on: ubuntu-latest
    needs: [ingest-8k-filings, ingest-10k-filings]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Generate daily summary
        run: |
          python .github/scripts/generate_daily_summary.py
      
      - name: Create issue with summary
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('.github/outputs/daily_summary.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Daily Ingestion Summary - ${new Date().toISOString().split('T')[0]}`,
              body: summary,
              labels: ['automated', 'daily-summary']
            });